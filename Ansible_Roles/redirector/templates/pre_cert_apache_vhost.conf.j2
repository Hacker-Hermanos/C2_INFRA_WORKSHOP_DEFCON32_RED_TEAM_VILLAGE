<VirtualHost *:{{ item.http_port }}>

# Incluir <REDIRECTOR_DOMAIN>. Este es el dominio frontend al que el Implante C2 enviará tráfico y apunta a la IP del Redirector.
# Este bloque configura un host virtual en Apache que escuchará en el puerto HTTP especificado

ServerName {{ item.redirector_domain }}
# Define el directorio raíz para los archivos del sitio web
DocumentRoot /var/www/html/{{ item.redirector_domain }}

# Documentación de niveles de registro: https://httpd.apache.org/docs/2.4/mod/core.html#loglevel
# Descomentar la siguiente línea para activar el registro detallado de las reglas de reescritura
# LogLevel alert rewrite:trace6

# Permitir listado de directorios
# Esta sección configura los permisos básicos para el directorio raíz de documentos

<Directory /var/www/html>
        # Habilita el listado de directorios y seguimiento de enlaces simbólicos
        Options Indexes FollowSymLinks
        # Permite la sobrescritura de configuración mediante archivos .htaccess
        AllowOverride All
        # Otorga acceso a todos los usuarios
        Require all granted
</Directory>

# Permitir verificacion de Let's Encrypt
# Esta configuración es necesaria para la validación del certificado SSL

Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
<Directory "/var/www/html/{{ item.redirector_domain }}/.well-known/acme-challenge/">
        # Deshabilita todas las opciones especiales
        Options None
        # No permite sobrescrituras de configuración
        AllowOverride None
        # Permite acceso a todos para la validación
        Require all granted
</Directory>

# Ubicación personalizada de registros
# Define dónde se almacenarán los archivos de registro para este dominio
ErrorLog /var/www/html/{{ item.redirector_domain }}/logs/error.log
CustomLog /var/www/html/{{ item.redirector_domain }}/logs/access.log combined

# Definir directorio para almacenar registros y denegar acceso
# Configuración de seguridad para proteger los archivos de registro
<Directory /var/www/html/{{ item.redirector_domain }}/logs>
        Order deny,allow
        Deny from all
</Directory>

# Cabeceras de Seguridad
# Esta sección configura importantes cabeceras HTTP para mejorar la seguridad

<IfModule mod_headers.c>
    # Previene el almacenamiento en caché del navegador
    Header set Cache-Control "no-store, no-cache, proxy-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
    # Fuerza HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    # Política de seguridad de contenido para prevenir XSS
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"
    # Protección contra ataques XSS
    Header always set X-XSS-Protection "1; mode=block"
    # Previene clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    # Previene MIME-type sniffing
    Header always set X-Content-Type-Options "nosniff"
    # Control de información de referencia
    Header always set Referrer-Policy "strict-origin"
    # Establece la codificación de caracteres
    Header set Content-Type "text/html; charset=utf-8"
</IfModule>

</VirtualHost>